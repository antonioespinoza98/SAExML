censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
select(-n, -distrito)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep)
head(censo_mrp);head(encuesta_mrp)
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
select(-n, -distrito)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
head(censo_mrp);head(encuesta_mrp)
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
select(-distrito, -n)
head(censo_mrp)
censo_mrp <- censo_mrp %>%
select(-distrito, -n)
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
select(-distrito)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep)
head(censo_mrp);head(encuesta_mrp)
encuesta_mrp %>%
group_by(pobreza) %>%
summarise(n_pobres = n())
encuesta_mrp <- encuesta_mrp %>%
left_join(encuesta_mrp, censo_mrp[,"dam","etnia"], by = "dam", all.x = TRUE)
encuesta_mrp <- encuesta_mrp %>%
left_join(encuesta_mrp, censo_mrp[,"dam","etnia"], by = "dam")
gc()
encuesta_mrp <- encuesta_mrp %>%
left_join(encuesta_mrp, censo_mrp[,"dam","etnia"], by = "dam", relationship = "many-to-many")
# Left join on 'dam' column
encuesta_mrp <- merge(encuesta_mrp, censo_mrp[, c("dam", "etnia")], by = "dam", all.x = TRUE)
View(encuesta_mrp)
View(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep)
encuesta_mrp$dam <- encuesta_mrp %>% transmute(
dam = case_when(dam == 01 ~ 1,
dam == 02 ~ 2,
dam == 03 ~ 3,
dam == 04 ~ 4,
dam == 05 ~ 5,
dam == 06 ~ 6))
encuesta_mrp <- merge(encuesta_mrp, censo_mrp[, c("dam", "etnia")], by = "dam", all.x = TRUE)
encuesta_mrp <- left_join(encuesta_mrp, censo_mrp %>% select(dam, etnia), by = "dam")
summary(encuesta_mrp)
View(encuesta_mrp)
encuesta_mrp$dam <- encuesta_mrp %>% transmute(
dam = case_when(dam == 01 ~ 1,
dam == 02 ~ 2,
dam == 03 ~ 3,
dam == 04 ~ 4,
dam == 05 ~ 5,
dam == 06 ~ 6))
View(encuesta_mrp)
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
head(censo_mrp);head(encuesta_mrp)
encuesta_mrp$dam <- encuesta_mrp %>% transmute(
dam = case_when(dam == 01 ~ 1,
dam == 02 ~ 2,
dam == 03 ~ 3,
dam == 04 ~ 4,
dam == 05 ~ 5,
dam == 06 ~ 6))
head(censo_mrp);head(encuesta_mrp)
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
encuesta_mrp <- encuesta_mrp %>% transmute(
dam = case_when(dam == 01 ~ 1,
dam == 02 ~ 2,
dam == 03 ~ 3,
dam == 04 ~ 4,
dam == 05 ~ 5,
dam == 06 ~ 6))
head(censo_mrp);head(encuesta_mrp)
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
encuesta_mrp <- encuesta_mrp %>% transmute(
dam = case_when(dam == 01 ~ 1,
dam == 02 ~ "2",
dam == 03 ~ 3,
dam == 04 ~ 4,
dam == 05 ~ 5,
dam == 06 ~ 6))
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
encuesta_mrp <- encuesta_mrp %>% mutate(
dam = case_when(dam == 01 ~ 1,
dam == 02 ~ 2,
dam == 03 ~ 3,
dam == 04 ~ 4,
dam == 05 ~ 5,
dam == 06 ~ 6))
head(censo_mrp);head(encuesta_mrp)
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
summary(censo_mrp); summary(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
summary(censo_mrp)
View(censo_mrp)
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n) %>%
mutate_if(is.character, as.factor)
summary(censo_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n) %>%
mutate_if(is.character , as.factor) %>%
mutate_if(is.numeric, as.factor)
summary(censo_mrp)
summary(encuesta_mrp)
summary(encuesta_mrp)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep)
summary(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n) %>%
mutate_if(is.character , as.factor) %>%
mutate_if(is.numeric, as.factor)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep) %>%
mutate_if(is.character, as.factor) %>%
mutate_if(is.numeric, as.factor)
summary(censo_mrp)
summary(encuesta_mrp)
encuesta_mrp <- encuesta_mrp %>% mutate(
dam = case_when(dam == 01 ~ "1",
dam == "02" ~ "2",
dam == "03" ~ "3",
dam == "04" ~ "4",
dam == "05" ~ "5",
dam == "06" ~ "6"))
View(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n) %>%
mutate_if(is.character , as.factor) %>%
mutate_if(is.numeric, as.factor)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep) %>%
mutate_if(is.character, as.factor) %>%
mutate_if(is.numeric, as.factor)
encuesta_mrp <- encuesta_mrp %>% mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)
)
View(encuesta_mrp)
encuesta_mrp <- left_join(encuesta_mrp, censo_mrp %>% select(dam, etnia), by = "dam")
summary(censo_mrp)
summary(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n) %>%
mutate_if(is.character , as.factor) %>%
mutate_if(is.numeric, as.factor)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor) %>%
mutate_if(is.numeric, as.factor) %>%
summary(censo_mrp)
summary(censo_mrp)
summary(encuesta_mrp)
summary(censo_mrp)
summary(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# inicialmente, a censo le quitamos n
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-distrito, -n) %>%
mutate_if(is.character , as.factor) %>%
mutate_if(is.numeric, as.factor)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-ingreso, -lp, -li,-fep) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor) %>%
mutate_if(is.numeric, as.factor)
summary(censo_mrp)
summary(encuesta_mrp)
encuesta_mrp <- left_join(encuesta_mrp, censo_mrp %>% select(dam, etnia), by = "dam")
encuesta_mrp <- left_join(encuesta_mrp, censo_mrp %>% select(dam, etnia), by = "dam", relationship = "many-to-many")
View(censo_mrp)
View(encuesta_mrp)
getwd()
rm(list =ls())
library(tidyverse)
library(formatR)
library(patchwork)
CONTEOS <- readRDS( file = "Data/ingreso/CONTEOS.RDS")
library(dplyr)
library(tidyverse)
library(readstata13)
library(haven)
library(DataExplorer)
library(redatam)
gc()
gc()
CONTEOS2 <-
CONTEOS %>% filter_at(vars(matches("_label")), all_vars(. !=  "__tot__"))
censo_mrp <- CONTEOS2 %>% transmute(
distrito = str_pad(
string = REDCODEN1_value,
width = 5,
pad = "0"
),
area = case_when(URBRUR2_value == 1 ~ "1", # 1 = Urbana
TRUE ~ "0"),   # 0 = Rural
sexo = as.character(SEXO3_value),
edad = case_when(
EDAD4_value %in% 0:14 ~ "1",       # 5 a 14
EDAD4_value %in% 15:29 ~ "2",      # 15 a 29
EDAD4_value %in% 30:44 ~ "3",      # 30 a 44
EDAD4_value %in% 45:64 ~ "4",      # 45 a 64
TRUE ~ "5"   ),                    # 65 o mas
anoest = case_when(
is.na(ANEST5_value) | EDAD4_value < 7 ~ "98",     # No aplica
ANEST5_value == 99 ~ "99", #NS/NR
ANEST5_value %in% 0 ~ "1",  # Sin educacion
ANEST5_value %in% c(1:6) ~ "2",  # 1-6
ANEST5_value %in% c(7:12) ~ "3",  # 7-12
ANEST5_value > 12 ~ "4" ,  # 12 o mas
TRUE ~ "Error"
),
etnia = case_when(
ETNIA7_value == 1 ~ "2",    # Afro
TRUE ~ "3" # Indigena
),
discapacidad = case_when(DISCAPA6_value == 0 ~ "0", TRUE ~ "1"),
value
)
cod5 <- c("70101", "70102", "70103", "70104", "70201", "70202",
"70203", "70204", "70205", "70206", "70207", "70301", "70302",
"70303", "70304", "70305", "70306", "70401", "70402", "70403",
"70404", "70501", "70502", "70503", "70601", "70602", "70603",
"70604", "70605")
cod3 <- c("20401", "20402", "20403", "20404", "20901", "20902",
"20903", "20904", "20905", "60101", "60102", "60103", "60104",
"60105", "60106", "60107", "60108", "60109", "60111", "60112",
"60113", "60114", "60115", "60116", "60201", "60202", "60203",
"60204", "60205", "60206", "60401", "60402", "60403", "60601",
"60602", "60603", "60901", "61101", "61102")
cod6 <- c( "20114", "20213", "20306", "21001", "21002", "21003",
"21004", "21005", "21006", "21007", "21008", "21009", "21010",
"21011", "21012", "21013", "21301", "21302", "21303", "21304",
"21305", "21306", "21307", "21308", "21401", "21402", "21403",
"21404", "21501", "21502", "21503", "21504", "41001", "41002",
"41003", "41004", "41005")
cod4 <- c( "11901", "11902", "11903", "11904", "11905", "11906",
"11907", "11908", "11909", "11910", "11911", "60301", "60302",
"60303", "60304", "60305", "60306", "60307", "60308", "60309",
"60501", "60502", "60503", "60504", "60505", "60506", "60701",
"60702", "60703", "60704", "60801", "60802", "60803", "60804",
"60805", "60806", "61001", "61002", "61003", "61004"  )
cod2 <- c( "50101", "50102", "50103", "50104", "50105",
"50201", "50202", "50203", "50204", "50205", "50206",
"50207", "50301", "50302", "50303", "50304", "50305",
"50306", "50307", "50308", "50309", "50401", "50402",
"50403", "50404", "50501", "50502", "50503", "50504",
"50601", "50602", "50603", "50604", "50605", "50701",
"50702", "50703", "50704", "50801", "50802", "50803",
"50804", "50805", "50806", "50807", "50901", "50902",
"50903", "50904", "50905", "50906", "51001", "51002",
"51003", "51004", "51101", "51102", "51103", "51104" )
cod1 <- c( "10101", "10102", "10103", "10104", "10105",
"10106", "10107", "10108", "10109", "10110", "10111",
"10201", "10202", "10203", "10301", "10302", "10303",
"10304", "10305", "10306", "10307", "10308", "10309",
"10310", "10311", "10312", "10313", "10401", "10402",
"10403", "10404", "10405", "10406", "10407", "10408",
"10409", "10501", "10502", "10503", "10601", "10602",
"10603", "10604", "10605", "10606", "10607", "10701",
"10702", "10703", "10704", "10705", "10706", "10801",
"10802", "10803", "10804", "10805", "10806", "10807",
"10901", "10902", "10903", "10904", "10905", "10906",
"11001", "11002", "11003", "11004", "11005", "11101",
"11102", "11103", "11104", "11105", "11201", "11202",
"11203", "11204", "11205", "11301", "11302", "11303",
"11304", "11305", "11401", "11402", "11403", "11501",
"11502", "11503", "11504", "11601", "11602", "11603",
"11604", "11605", "11701", "11702", "11703", "11801",
"11802", "11803", "11804", "12001", "12002", "12003",
"12004", "12005", "12006", "20101", "20102", "20103",
"20104", "20105", "20106", "20107", "20108", "20109",
"20110", "20111", "20112", "20113", "20201", "20202",
"20203", "20204", "20205", "20206", "20207", "20208",
"20209", "20210", "20211", "20212", "20301", "20302",
"20303", "20304", "20305", "20307", "20308", "20501",
"20502", "20503", "20504", "20505", "20506", "20507",
"20508", "20601", "20602", "20603", "20604", "20605",
"20606", "20607", "20608", "20701", "20702", "20703",
"20704", "20705", "20706", "20707", "20801", "20802",
"20803", "20804", "20805", "21101", "21102", "21103",
"21104", "21105", "21106", "21107", "21201", "21202",
"21203", "21204", "21205", "30101", "30102", "30103",
"30104", "30105", "30106", "30107", "30108", "30109",
"30110", "30111", "30201", "30202", "30203", "30204",
"30205", "30301", "30302", "30303", "30304", "30305",
"30306", "30307", "30308", "30401", "30402", "30403",
"30501", "30502", "30503", "30504", "30505", "30506",
"30507", "30508", "30509", "30510", "30511", "30512",
"30601", "30602", "30603", "30701", "30702", "30703",
"30704", "30705", "30801", "30802", "30803", "30804",
"40101", "40102", "40103", "40104", "40105", "40201",
"40202", "40203", "40204", "40205", "40206", "40301",
"40302", "40303", "40304", "40305", "40306", "40307",
"40308", "40401", "40402", "40403", "40404", "40405",
"40406", "40501", "40502", "40503", "40504", "40505",
"40601", "40602", "40603", "40604", "40701", "40702",
"40703", "40801", "40802", "40803", "40901", "40902" )
censo1 <- censo_mrp %>%
mutate(
dam =
case_when(
distrito %in% cod1 ~ 1 ,
distrito %in% cod2 ~ 2 ,
distrito %in% cod3 ~ 3 ,
distrito %in% cod4 ~ 4 ,
distrito %in% cod5 ~ 5 ,
distrito %in% cod6 ~ 6))
censo_mrp2 <- censo1 %>% mutate(dam = str_pad(
string = dam,
width = 2,
pad = "0"
))
saveRDS(censo_mrp2, "Data/ingreso/censo_mrp.rds")
rm(list = ls())
gs()
gc()
gc()
readRDS("Data/ingreso/censo_mrp.rds")
censo_mrp2 <- readRDS("Data/ingreso/censo_mrp.rds")
censo_mrp2 %>% select(-value)
censo_mrp2 <- censo_mrp2 %>% select(-value)
saveRDS(censo_mrp2, "Data/ingreso/censo_mrp.rds")
rm(list = ls())
censo_mrp2 <- readRDS("Data/ingreso/censo_mrp.rds")
gc()
rm(list = ls())
readRDS("Data/ingreso/censo_mrp.rds")
censo_mrp2 <- readRDS("Data/ingreso/censo_mrp.rds")
censo_mrp2 <- censo_mrp2 %>% select(-distrito)
saveRDS(censo_mrp2, "Data/ingreso/censo_mrp.rds")
rm(list = ls())
# -------------------------------------------------------------------------
####################################################
### Loading datasets: CASEN and Population census ###
####################################################
encuesta <- readRDS("Data/ingreso/encuestaCRI21n.rds")
censo_mrp <- readRDS( "Data/ingreso/censo_mrp.rds")
encuesta_mrp <- encuesta %>% transmute(
dam = str_pad(
string = dam_ee,
width = 2,
pad = "0"
),
area = case_when(area_ee == 1 ~ "1", TRUE ~ "0"),
ingreso = ingcorte,
lp,
li,
sexo = as_factor(sexo, levels = "values"),
anoest = case_when(
is.na(anoest) | edad < 7  ~ "98"   ,     #No aplica
anoest == 99 ~ "99",    #NS/NR
anoest == 0  ~ "1",     # Sin educacion
anoest %in% c(1:6) ~ "2",     # 1 - 6
anoest %in% c(7:12) ~ "3",     # 7 - 12
anoest > 12 ~ "4",     # mas de 12
TRUE ~ "Error"
),
edad = case_when(edad < 15 ~ "1",
edad < 30 ~ "2",
edad < 45 ~ "3",
edad < 65 ~ "4",
TRUE ~ "5"),
discapacidad = discapacidad_ee,
fep = `_fep`
)
rm(list = ls())
x <- c('rpart','rattle','DT','adabag','randomForest','haven','dplyr')
lapply(x, require, character.only = TRUE)
rm(list = ls())
x <- c('rpart','rattle','DT','adabag','randomForest','haven','dplyr')
lapply(x, require, character.only = TRUE)
load("pobreza/datos/encuesta_df_agg.Rdata")
# pasar a factor estos dos
encuesta_df_agg$area <- as.factor(encuesta_df_agg$area)
encuesta_df_agg$pobreza <- as.factor(encuesta_df_agg$pobreza)
# de character a factor para el resto
base <- encuesta_df_agg %>%
select(-dam, -ingreso, -lp,-li, -fep) %>%
mutate_if(is.character, as.factor)
summary(base)
save(base, file = "pobreza/datos/base.Rdata")
rm(list = ls())
load("pobreza/datos/base.Rdata")
RNGkind(sample.kind = "Rounding")
set.seed(10)
n = nrow(base)
s = sample(1:n, round(0.8*n))
train = base[s, ]
test = base[-s, ]
mod = rpart(pobreza ~ ., method = "class",cp = 0.001, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod = rpart(pobreza ~ ., method = "class",cp = 0.0003, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod$splits
mod = rpart(pobreza ~ ., method = "class",cp = 0.0004, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod = rpart(pobreza ~ ., method = "class",cp = 0.0005, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod = rpart(pobreza ~ ., method = "class",cp = 0.0006, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod = rpart(pobreza ~ ., method = "class",cp = 0.0007, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod = rpart(pobreza ~ ., method = "class",cp = 0.0008, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
mod = rpart(pobreza ~ ., method = "class",cp = 0.0007, data = train)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
pred = predict(mod, newdata = test, type = "class")
test$pred <- pred
head(cbind(test$cliente, test$pred), 20)
head(cbind(test$pobreza, test$pred), 20)
table(test$pobreza, test$pred)
table(test$pobreza)
table(test$pred)
tabla = table(test$pobreza, test$pred)
prop.table(tabla, 1)
