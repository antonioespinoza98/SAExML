mod = rpart(pobreza ~ ., method = "class", data = encuesta_mrp)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
View(censo_mrp)
View(censo_mrp)
View(censo_mrp)
View(encuesta_mrp)
encuesta_mrp %>%
group_by(dam) %>%
summarise(
n = n()
)
encuesta_mrp %>%
group_by(dam, pobreza) %>%
summarise(
n = n()
)
encuesta_mrp %>%
group_by(dam, pobreza, anoest) %>%
summarise(
n = n()
)
names(encuesta_mrp)
censo_mrp <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
inner_join(encuesta_mrp["pobreza"], by = "dam")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
inner_join(encuesta_mrp["pobreza","dam"], by = "dam")
head(censo_mrp$dam)
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
inner_join(encuesta_mrp["pobreza","dam"], by = "dam")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6))) %>%
inner_join(encuesta_mrp["pobreza","dam"], by = "dam")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6)))
censo_mrp_cl <- inner_join(censo_mrp_cl,encuesta_mrp["pobreza","dam"], by = "dam")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6)))
censo_mrp_cl <- merge(censo_mrp_cl,encuesta_mrp["pobreza","dam"], by = "dam")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6)))
View(censo_mrp_cl)
View(encuesta_mrp)
encuesta_mrp["pobreza","dam"]
encuesta_mrp["pobreza","dam"]
encuesta_mrp[,"pobreza","dam"]
encuesta_mrp[,c("pobreza","dam")]
censo_mrp_cl <- merge(censo_mrp_cl,encuesta_mrp[,c("pobreza","dam")], by = "dam")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6)))
censo_mrp_cl <- inner_join(censo_mrp_cl,encuesta_mrp[,c("pobreza","dam")], by = "dam")
censo_mrp_cl <- inner_join(censo_mrp_cl,encuesta_mrp[,c("pobreza","dam")], by = "dam", relationship = "many-to-many")
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6)))
censo_mrp_cl <- merge(censo_mrp_cl, encuesta_mrp, by="dam", all.x=TRUE)
View(censo_mrp_cl)
censo_mrp_cl <- censo_mrp %>%
select(dam, area, sexo, anoest, edad) %>%
mutate(
dam = factor(dam,
levels = c("01", "02", "03", "04", "05", "06"),
labels = c(1, 2, 3, 4, 5, 6)))
censo_mrp_cl$pobreza <- encuesta_mrp$pobreza
#############################
## Limpiar ambiente
#############################
rm(list = ls())
encuesta_mrp18 <- read_dta("V:/DAT/BADEHOG/BADEHOG_EXT/CRI_2018N1.dta",
encoding = "LATIN1")
encuesta_mrp19 <- read_dta("V:/DAT/BADEHOG/BADEHOG_EXT/CRI_2019N1.dta",
encoding = "LATIN1")
#############################
## Limpieza 2018
#############################
encuesta_mrp18 <- encuesta_mrp18 %>% transmute(
dam = str_pad(
string = dam_ee,
width = 2,
pad = "0"
),
area = case_when(area_ee == 1 ~ "1", TRUE ~ "0"),
ingreso = ingcorte,
lp,
li,
sexo = as_factor(sexo, levels = "values"),
anoest = case_when(
is.na(anoest) | edad < 7  ~ "98"   ,     #No aplica
anoest == 99 ~ "99",    #NS/NR
anoest == 0  ~ "1",     # Sin educacion
anoest %in% c(1:6) ~ "2",     # 1 - 6
anoest %in% c(7:12) ~ "3",     # 7 - 12
anoest > 12 ~ "4",     # mas de 12
TRUE ~ "Error"
),
edad = case_when(edad < 15 ~ "1",
edad < 30 ~ "2",
edad < 45 ~ "3",
edad < 65 ~ "4",
TRUE ~ "5"),
# discapacidad = discapacidad_ee,
fep = `_fep`
) %>%
mutate(pobreza = ifelse(ingreso <= lp, 1, 0))
encuesta_mrp19 <- encuesta_mrp19 %>% transmute(
dam = str_pad(
string = dam_ee,
width = 2,
pad = "0"
),
area = case_when(area_ee == 1 ~ "1", TRUE ~ "0"),
ingreso = ingcorte,
lp,
li,
sexo = as_factor(sexo, levels = "values"),
anoest = case_when(
is.na(anoest) | edad < 7  ~ "98"   ,     #No aplica
anoest == 99 ~ "99",    #NS/NR
anoest == 0  ~ "1",     # Sin educacion
anoest %in% c(1:6) ~ "2",     # 1 - 6
anoest %in% c(7:12) ~ "3",     # 7 - 12
anoest > 12 ~ "4",     # mas de 12
TRUE ~ "Error"
),
edad = case_when(edad < 15 ~ "1",
edad < 30 ~ "2",
edad < 45 ~ "3",
edad < 65 ~ "4",
TRUE ~ "5"),
# discapacidad = discapacidad_ee,
fep = `_fep`
) %>%
mutate(pobreza = ifelse(ingreso <= lp, 1, 0))
saveRDS(encuesta_mrp18, file = "pobreza/datos/encuesta_mrp18.rds")
saveRDS(encuesta_mrp19, file = "pobreza/datos/encuesta_mrp19.rds")
encuesta_mrp22 <- readRDS("pobreza/datos/encuesta_mrp22.rds")
encuesta_mrp18 <- encuesta_mrp18 %>%
select(-lp,-li,-fep,-ingreso) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp18$dam <- as.factor(encuesta_mrp18$dam)
encuesta_mrp18$pobreza <- as.factor(encuesta_mrp18$pobreza)
encuesta_mrp19 <- encuesta_mrp19 %>%
select(-lp,-li,-fep,-ingreso) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp19$dam <- as.factor(encuesta_mrp19$dam)
encuesta_mrp19$pobreza <- as.factor(encuesta_mrp19$pobreza)
encuesta_mrp22 <- encuesta_mrp22 %>%
select(-lp,-li,-fep,-ingreso) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp22$dam <- as.factor(encuesta_mrp22$dam)
encuesta_mrp22$pobreza <- as.factor(encuesta_mrp22$pobreza)
table(encuesta_mrp18$pobreza)
table(encuesta_mrp22$pobreza)
encuesta_mrp18_pob <- subset(encuesta_mrp18, pobreza == 1)
encuesta_mrp <- rbind(encuesta_mrp22, encuesta_mrp18_pob)
table(encuesta_mrp$pobreza)
mod = rpart(pobreza ~ ., method = "class", data = encuesta_mrp)
fancyRpartPlot(mod, palettes = c("Greens","Reds"))
pred = predict(mod, newdata = encuesta_mrp19, type = "class")
encuesta_mrp19$pred <- pred
head(cbind(encuesta_mrp19$pobreza, encuesta_mrp19$pred), 20)
tabla = table(test$pobreza, test$pred)
tabla = table(encuesta_mrp19$pobreza, encuesta_mrp19$pred)
tabla
prop.table(tabla, 1)
table(encuesta_mrp18$pobreza)
table(encuesta_mrp22$pobreza)
encuesta_mrp[encuesta_mrp$anoest == 3:4, ]
# proporcion de personas en el nodo terminal izquierdo
nrow(encuesta_mrp[encuesta_mrp$anoest == 3:4, ])
# proporcion de personas en el nodo terminal izquierdo
nrow(encuesta_mrp[encuesta_mrp$anoest == 3:4, ])/nrow(encuesta_mrp)
table(encuesta_mrp$anoest == 3:4, ]$anoest)
table(encuesta_mrp[encuesta_mrp$anoest == 3:4, ]$anoest)
# proporcion de personas en el nodo terminal izquierdo
subset(encuesta_mrp, anoest == 3:4)
encuesta_mrp[encuesta_mrp$anoest == 3:4, ]
# proporcion de personas en el nodo terminal izquierdo
nrow(subset(encuesta_mrp, anoest == 3:4))
# proporcion de personas en el nodo terminal izquierdo
nrow(subset(encuesta_mrp, anoest == 3:4))/37032
# proporcion de personas en el nodo terminal izquierdo
table(encuesta_mrp$anoest)
13067+5035
18102/37032
mod$ordered
mod$variable.importance
mod$cptable
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# debemos de quitar algunas variables
censo_mrp <- censo_mrp %>%
select(-area, -etnia, -sexo,-edad,-anoest,-discapacidad,-n) %>%
mutate_if(is.character , as.factor)
x <- c('rpart','rattle','DT','adabag','randomForest','haven','dplyr')
lapply(x, require, character.only = TRUE)
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# debemos de quitar algunas variables
censo_mrp <- censo_mrp %>%
select(-area, -etnia, -sexo,-edad,-anoest,-discapacidad,-n) %>%
mutate_if(is.character , as.factor)
summary(censo_mrp)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-area,-ingreso,-lp,-li,-sexo,-anoest,-edad,-discapacidad,
-fep) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp$dam <- as.factor(encuesta_mrp$dam)
encuesta_mrp$pobreza <- as.factor(encuesta_mrp$pobreza)
View(encuesta_mrp)
rm(list = ls())
# Base de datos para encuesta y para censo
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
encuesta_mrp <- readRDS("pobreza/datos/encuesta_mrp.rds")
# debemos de quitar algunas variables
censo_mrp <- censo_mrp %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-n,-etnia) %>%
mutate_if(is.character , as.factor)
summary(censo_mrp)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-fep,-ingreso) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp$dam <- as.factor(encuesta_mrp$dam)
encuesta_mrp$pobreza <- as.factor(encuesta_mrp$pobreza)
RNGkind(sample.kind = "Rounding")
set.seed(10)
encuesta_mrp %>%
group_by(pobreza) %>%
summarise(n_pobres = n())
rm(list = ls())
encuesta_mrp18 <- readRDS("pobreza/datos/encuesta_mrp18.rds")
encuesta_mrp19 <- readRDS("pobreza/datos/encuesta_mrp19.rds")
encuesta_mrp22 <- readRDS("pobreza/datos/encuesta_mrp22.rds")
encuesta_mrp18 <- encuesta_mrp18 %>%
select(-lp,-li,-fep,-ingreso) %>% # Se eliminan estas columnas
mutate(
dam = recode(dam, # Se le hizo una recodificacion a dam para que queden entre 0 y 6.
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor) # mutate para convertir las variables que deben ser factores.
encuesta_mrp18$dam <- as.factor(encuesta_mrp18$dam)
encuesta_mrp18$pobreza <- as.factor(encuesta_mrp18$pobreza)
encuesta_mrp19 <- encuesta_mrp19 %>%
select(-lp,-li,-fep,-ingreso) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp19$dam <- as.factor(encuesta_mrp19$dam)
encuesta_mrp19$pobreza <- as.factor(encuesta_mrp19$pobreza)
encuesta_mrp22 <- encuesta_mrp22 %>%
select(-lp,-li,-fep,-ingreso) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp22$dam <- as.factor(encuesta_mrp22$dam)
encuesta_mrp22$pobreza <- as.factor(encuesta_mrp22$pobreza)
encuesta_mrp18_pob <- subset(encuesta_mrp18, pobreza == 1)
encuesta_mrp <- rbind(encuesta_mrp22, encuesta_mrp18_pob)
mod = rpart(pobreza ~ ., method = "class", data = encuesta_mrp)
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds")
View(censo_mrp)
names(encuesta_mrp)
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds") %>%
select(dam, area,sexo, anoest, edad)
pred = predict(mod, newdata = censo_mrp, type = "class")
View(encuesta_mrp)
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds") %>%
select(dam, area,sexo, anoest, edad) %>%
mutate_if(is.character , as.factor) mutate(
censo_mrp <- readRDS("pobreza/datos/censo_mrp.rds") %>%
select(dam, area,sexo, anoest, edad) %>%
mutate_if(is.character , as.factor) %>%  mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6))
View(censo_mrp)
pred = predict(mod, newdata = censo_mrp, type = "class")
summary(censo_mrp)
censo_mrp$dam <- as.factor(censo_mrp$dam)
pred = predict(mod, newdata = censo_mrp, type = "class")
print(pred)
table(pred)
prop.table(tabla, 1)
table <- table(pred)
prop.table(tabla, 1)
tabla <- table(pred)
prop.table(tabla, 1)
table(pred)
View(censo_mrp)
?xgboost
model1 <- readRDS("ingreso/datos/model1.rds")
### Step 4: Extract the results-------------------------------------------------
head(summarize_indicators(model1, MSE = TRUE, CV =TRUE))
x <- c('SAEforest','caret','dplyr')
lapply(x, require, character.only = TRUE)
### Step 4: Extract the results-------------------------------------------------
head(summarize_indicators(model1, MSE = TRUE, CV =TRUE))
randomForest(ingreso ~ .,data = encuesta_mrp, mtry = 9, importance = TRUE,
na.action = na.omit)
library(randomForest)
censo_mrp <- readRDS("ingreso/datos/censo_mrp1.rds")
encuesta_mrp <- readRDS("ingreso/datos/encuesta_mrp1.rds")
encuesta_mrp$ingreso <- encuesta_mrp$ingreso + 1
# debemos de quitar algunas variables
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-n,-etnia,
-distrito,-area,-sexo,-anoest,-edad,-discapacidad) %>%
mutate_if(is.character , as.factor) %>%  mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6))
library(tidyverse)
# debemos de quitar algunas variables
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-n,-etnia,
-distrito,-area,-sexo,-anoest,-edad,-discapacidad) %>%
mutate_if(is.character , as.factor) %>%  mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6))
censo_mrp$dam <- as.factor(censo_mrp$dam)
summary(censo_mrp)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-fep,-pobreza,
-area,-sexo,-anoest,-edad,-discapacidad) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp$dam <- as.factor(encuesta_mrp$dam)
summary(encuesta_mrp)
mod <- randomForest(ingreso ~ .,data = encuesta_mrp, mtry = 9, importance = TRUE,
na.action = na.omit)
pred <- predict(mod, newdata = censo_mrp, type = "response")
censo_mrp$pred <- pred
View(censo_mrp)
table(pred)
rm(list = ls())
censo_mrp <- readRDS("ingreso/datos/censo_mrp1.rds")
encuesta_mrp <- readRDS("ingreso/datos/encuesta_mrp1.rds")
encuesta_mrp$ingreso <- encuesta_mrp$ingreso + 1
# debemos de quitar algunas variables
censo_mrp <- censo_mrp %>%
ungroup() %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-n,-etnia,
-distrito) %>%
mutate_if(is.character , as.factor) %>%  mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6))
censo_mrp$dam <- as.factor(censo_mrp$dam)
summary(censo_mrp)
# Encuesta quitamos ingreso, lp, li y fep
encuesta_mrp <- encuesta_mrp %>%
select(-X2016_crops.coverfraction, -X2016_urban.coverfraction,
-X2016_gHM, -accessibility, -accessibility_walking_only,
-area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
-anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-fep,-pobreza) %>%
mutate(
dam = recode(dam,
"01" = 1,
"02" = 2,
"03" = 3,
"04" = 4,
"05" = 5,
"06" = 6)) %>%
mutate_if(is.character, as.factor)
encuesta_mrp$dam <- as.factor(encuesta_mrp$dam)
summary(encuesta_mrp)
mod <- randomForest(ingreso ~ .,data = encuesta_mrp, mtry = 9, importance = TRUE,
na.action = na.omit)
pred <- predict(mod, newdata = censo_mrp, type = "response")
censo_mrp$pred <- pred
table(pred)
View(censo_mrp)
