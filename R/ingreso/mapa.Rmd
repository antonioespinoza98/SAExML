---
output: html_document
editor_options: 
  chunk_output_type: console
---

Autor: Marco Espinoza
CEPAL - División de Estadística
fecha: mayo - 2024



# Mapa de ingreso medio para Costa Rica

```{r}
rm(list = ls())
```


# Librerias

```{r}
x <- c('tidyverse','sf','httr2','ows4R','rmapshaper','janitor')
lapply(x, require, character.only = TRUE)
```

# Extracción de información geoespacial

Nota: Este código es ilustrativo. Ya que el archivo final está guardado en la carpeta *output* con el nombre de: `cantones_cr.geojson` 

Para más información, revisar la siguiente [página](https://www.snitcr.go.cr/ico_servicios_ogc_info?k=bm9kbzo6OTM=&nombre=IGN%20Cartograf%C3%ADa%201:5mil%20CO)


```{r}
# Link dado por el SNIT de Costa Rica 
url_wfs <- "https://geos.snitcr.go.cr/be/IGN_5_CO/wfs?"
```

```{r}
# Aquí se crea la conexión
bwk_client <- WFSClient$new(
  url = url_wfs,
  serviceVersion = "2.0.0"
)

as_tibble(bwk_client$getFeatureTypes(pretty = TRUE))
```

```{r}
# En esta parte del código se hace el GET request de la información
# En este caso nos interesa extraer la provincia y el cantón.
url <- url_parse(url_wfs)
url$query <- list(
  service = "wfs",
  request = "GetFeature",
  typename = "IGN_5_CO:limitecantonal_5k",
  srsName = "EPSG:4326"
)
request <- url_build(url)

regiones <- read_sf(request) |>
  select("CÓDIGO_CANTÓN", "PROVINCIA", "CANTÓN")
st_crs(regiones) <- st_crs(4326)
```

```{r}
glimpse(regiones)
```

```{r}
ggplot(
  data = regiones
) +
  geom_sf(color = "white", fill = "#365486") +
  theme_minimal()
```

El siguiente código lo que produce es la simplificación de la regiones y el mapa. Esto quiere decir que se reduce las dimensiones para poder apreciar de mejor manera el mapa. Además de esto, también se reduce su tamaño computacionalmente. Aquí estamos quitando la Isla del Coco. 

```{r}
regiones_simplificadas <- ms_simplify(
  input = regiones,
  keep = 0.05,
  keep_shapes = FALSE
)

# eliminar la isla del coco
regiones_simplificadas <- ms_filter_islands(
  input = regiones_simplificadas,
  min_area = 24000000
)
```

Una vez, guardamos el archivo para el nivel cantonal. Este archivo es el final y es el que se debe utilizar. 

```{r}
write_sf(
  obj = regiones_simplificadas, dsn = "ingreso/output/cantones_cr.geojson")
```

# Mapa para los cantones de Costa Rica

leemos el archivo recién creado.

*NOTA:* También estamos quitando a los cantones de Monterverde, Río Cuarto y Puerto Jimenez. Esto se debe a que para el censo del 2011 estos cantones aún no existian dado que se crearon en años posteriores. 

```{r}
cantones <- st_read("ingreso/output/cantones_cr.geojson", quiet = TRUE)
cantones <- janitor::clean_names(cantones)



cantones <- cantones |> 
  mutate(
    canton = case_match(
      canton,
      "Puerto Jiménez" ~ "Golfito",
      "Monteverde" ~ "Puntarenas",
      "Río Cuarto" ~ "Grecia",
      .default = canton
    ),
    codigo_canton = case_match(
      canton,
      "613" ~ "607",
      "612" ~ "601",
      "216" ~ "203",
      .default = canton
    )
  )

cantones <- cantones |> 
  summarise(
    geometry = st_union(geometry),
    .by = c(codigo_canton,provincia, canton)
  )

write_sf(obj = cantones, dsn = "ingreso/datos/cantones_ajustado_cr.geojson")
```


Leemos la base resumen del ingreso cantonal

```{r}
ingreso_cantonal <- readRDS("ingreso/output/ingreso_cantonal.rds")
```

Unimos las dos bases de datos

```{r}
mapa <- left_join(
  x = cantones,
  y = ingreso_cantonal,
  by = join_by(canton == canton)
)

glimpse(mapa)
```

```{r}
mapa_plot <- ggplot(
  data = mapa,
  mapping = aes(
    fill = ingreso_medio
  )
) +
  geom_sf(color = "white") +
  labs(fill = "Ingreso medio") +
  scale_fill_viridis_c() +
  theme_minimal()
```

```{r}
ggsave(mapa_plot, filename = "ingreso/output/mapa_cantonal.png")
```

# Mapa para las regiones de planificación

```{r}
rm(list = ls())
```

```{r}
url_wfs <- "https://geos.snitcr.go.cr/be/IGN_5_CO/wfs?"

url <- url_parse(url_wfs)
url$query <- list(
  service = "wfs",
  request = "GetFeature",
  typename = "IGN_5_CO:limitedistrital_5k",
  srsName = "EPSG:4326"
)
request <- url_build(url)

regiones <- read_sf(request) |>
  select("CÓDIGO_DTA", "PROVINCIA", "CANTÓN", "DISTRITO", "REGIÓN")
st_crs(regiones) <- st_crs(4326)
```


```{r}
regiones_simplificadas <- ms_simplify(input = regiones,
                                      keep = 0.05,
                                      keep_shapes = FALSE)

# eliminar la isla del coco
regiones_simplificadas <- ms_filter_islands(input = regiones_simplificadas, min_area = 24000000)
write_sf(obj = regiones_simplificadas, dsn = "ingreso/datos/distritos_cr.geojson")
```

```{r}
distritos <- st_read("ingreso/datos/distritos_cr.geojson", quiet = TRUE)
distritos <- janitor::clean_names(distritos)

res <- distritos |>
  summarise(geometry = st_union(geometry), .by = region)

write_sf(obj = res, dsn = "ingreso/datos/regiones_cr.geojson")
```


```{r}
regiones <- st_read("ingreso/datos/regiones_cr.geojson")
```


```{r}
ggplot(
  data = regiones) +
  geom_sf(color = "white", fill = "#365486") +
  theme_minimal()
```

```{r}
ingreso_region <- readRDS("ingreso/output/ingreso_region.rds")
```

```{r}
mapping <- left_join(
  x = regiones,
  y = ingreso_region,
  by = join_by(region == region)
)
```

```{r}

region_plot <- ggplot(
  data = mapping,
  mapping = aes(
    fill = ingreso_medio
  )
) +
  geom_sf(color = "white") +
  labs(fill = "Ingreso medio") +
  scale_fill_viridis_c() +
  theme_minimal()
```

```{r}
ggsave(region_plot, filename = "ingreso/output/mapa_mideplan.png")
```




