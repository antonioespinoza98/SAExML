---
output: html_document
editor_options: 
  chunk_output_type: console
---

Autor: Marco Espinoza
CEPAL - División de Estadística
fecha: mayo - 2024



```{r}
rm(list = ls())
```

```{r}
x <- c('tidyverse','survey','srvyr')
lapply(x, require, character.only = TRUE)
```

```{r}
encuesta_mrp <- readRDS("ingreso/datos/encuesta_mrp1.rds") %>% 
  select(
    # -X2016_crops.coverfraction, -X2016_urban.coverfraction,
    #      -X2016_gHM, -accessibility, -accessibility_walking_only,
         -area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
         -anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-pobreza) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(dam = as.factor(dam))
```

```{r}
diseno <- encuesta_mrp  %>% 
  as_survey_design(weights = fep)
```

```{r}
media_est_srvyr <- diseno %>% 
  group_by(dam) %>% 
  summarise(media_ingreso = mean(ingreso))
```

```{r}
censo_mrp <- censo_mrp <- readRDS("ingreso/datos/censo_mrp1.rds") %>% 
      mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>% 
  mutate(region = as.factor(region))


pred <- readRDS("ingreso/output/pred.rds")

censo_mrp$pred_ingreso <- pred
```

```{r}
ingreso_dam <- censo_mrp %>% 
  group_by(region) %>% 
  summarise(
    media_ingreso = mean(pred_ingreso)
  ) 
```


```{r}

colnames(ingreso_dam) <- c("Domain", "Direct")
mapping <- rbind(DIR[,c(1,3)], ingreso_dam)

estim <- c(rep("Directo", 6), rep("XGBoost", 6))

mapping <- cbind(mapping, estim)
```

```{r}
plot_validacion <- mapping %>% 
  ggplot(
    aes(x = Domain,
        y = Direct,
        col = estim)
  ) + geom_point(size = 2) + theme_minimal() +
    scale_color_manual(values = c("red","green")) +  
  labs(x = "Dam", y = "Ingreso medio", fill = "Modelo")
```

```{r}
ggsave(plot_validacion, filename = "ingreso/output/validacion.png")
```




```{r}
censo_mrp %>%
  group_by(dam) %>% 
  summarise(
  media_ingreso = mean(pred_ingreso)
)
```

```{r}
encuesta_mrp %>% 
  group_by(dam) %>% 
  summarise(
    media_ingreso = mean(ingreso)
  )
```

```{r}
encuesta_mrp <- readRDS("ingreso/datos/encuesta_mrp1.rds") %>% 
  dplyr::select(
    # -X2016_crops.coverfraction, -X2016_urban.coverfraction,
    #      -X2016_gHM, -accessibility, -accessibility_walking_only,
         -area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
         -anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-pobreza) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(dam = as.factor(dam)) %>% 
      mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>% 
  mutate(region = as.factor(region))

encuesta_mrp <- as.data.frame(encuesta_mrp)

popsize <- encuesta_mrp %>% group_by(region) %>% 
  summarise(n = n())

popsize <- as.data.frame(popsize)

encuesta_mrp$fep <- as.numeric(encuesta_mrp$fep)

DIR <- direct(y = encuesta_mrp$ingreso, dom = encuesta_mrp$region,
              sweight = encuesta_mrp$fep, domsize = popsize)

```




```{r}
library(sae)

encuesta_agg <- readRDS("ingreso/datos/encuesta_df_agg.rds") %>% 
    mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>% 
  mutate(region = as.factor(region))

encuesta_agg <- as.data.frame(encuesta_agg)

popsize <- encuesta_agg %>% group_by(region) %>% 
  summarise(n = sum(n))
popsize <- as.data.frame(popsize)
encuesta_agg$fep <- as.numeric(encuesta_agg$fep)

DIR <- direct(y = encuesta_agg$ingreso, dom = encuesta_agg$region,
              sweight = encuesta_agg$fep, domsize = popsize)
DIR
```

```{r}
data("incomedata")
data("sizeprov")

Popn <- sizeprov[, c("provlab", "Nd")]
incomedata %>% group_by(provlab) %>% summarise(n = n())
DIR <- direct(y = incomedata$income, dom = incomedata$provlab,
              sweight = incomedata$weight, domsize = Popn)

```
















