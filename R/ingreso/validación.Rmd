---
output: html_document
editor_options: 
  chunk_output_type: console
---

Autor: Marco Espinoza
CEPAL - División de Estadística
fecha: mayo - 2024



```{r}
rm(list = ls())
```

```{r}
x <- c('tidyverse','survey','srvyr', 'data.table')
lapply(x, require, character.only = TRUE)
```

```{r}
encuesta_mrp <- readRDS("ingreso/datos/encuesta_mrp1.rds") %>% 
  # select(
  #   # -X2016_crops.coverfraction, -X2016_urban.coverfraction,
  #   #      -X2016_gHM, -accessibility, -accessibility_walking_only,
  #        -area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
  #        -anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-pobreza) %>% 
        mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>%
  mutate(region = as.factor(region)) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(dam = as.factor(dam))
```

```{r}
diseno <- encuesta_mrp  %>% 
  as_survey_design(weights = fep)
```

```{r}
media_est_srvyr <- svyby(
  ~ingreso,
  by = ~region,
  design = diseno,
  svymean
)
```

```{r}
confint_int <- confint(svyby(formula = ~ingreso,
                             by = ~region,
                             design = diseno,
                             svymean))

confint_int <- data.table(confint_int, keep.rownames = TRUE)
colnames(confint_int) <- c("region","min_inter", "max_inter")

confint_int$ingreso <- media_est_srvyr$ingreso

```



```{r}
censo_mrp <- censo_mrp <- readRDS("ingreso/datos/censo_mrp1.rds") %>%  
      mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>%
  mutate(region = as.factor(region))
```


```{r}
pred <- readRDS("ingreso/output/pred.rds")

censo_mrp$pred_ingreso <- pred
```

```{r}
ingreso_dam <- censo_mrp %>% 
  group_by(region) %>% 
  summarise(
    ingreso = mean(pred_ingreso)
  ) 
```


```{r}
mapping <- rbind(media_est_srvyr[,-3], ingreso_dam)

estim <- c(rep("Directo", 6), rep("XGBoost", 6))

mapping <- cbind(mapping, estim)
```

```{r}
mapping %>% 
  ggplot(
    aes(x = region,
        y = ingreso)
  ) + geom_point(aes(color = estim),size = 2, position = "jitter") + theme_minimal() +
    scale_color_manual(values = c("red","green")) +  
  labs(x = "Región de planificación", y = "Ingreso medio", col = "Modelo") + 
  geom_errorbar(data = confint_int,aes(x= region, ymin = min_inter,
                                       ymax = max_inter))
```

```{r}
ggsave(plot_validacion, filename = "ingreso/output/validacion.png")
```

