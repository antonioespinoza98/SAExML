---
output: html_document
editor_options: 
  chunk_output_type: console
---

Autor: Marco Espinoza
CEPAL - División de Estadística
fecha: mayo - 2024



```{r}
rm(list = ls())
```

```{r}
x <- c('tidyverse','survey','srvyr')
lapply(x, require, character.only = TRUE)
```

```{r}
encuesta_mrp <- readRDS("ingreso/datos/encuesta_mrp1.rds") %>% 
  select(
    # -X2016_crops.coverfraction, -X2016_urban.coverfraction,
    #      -X2016_gHM, -accessibility, -accessibility_walking_only,
         -area1, -sexo2,-edad2,-edad3, -edad4,-edad5,-anoest2,
         -anoest3, -anoest4, -discapacidad1,-etnia1,-lp,-li,-pobreza) %>% 
        mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>%
  mutate(region = as.factor(region)) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(dam = as.factor(dam))
```

```{r}
diseno <- encuesta_mrp  %>% 
  as_survey_design(weights = fep)
```

```{r}
media_est_srvyr <- svyby(
  ~ingreso,
  by = ~region,
  design = diseno,
  svymean
)
```

```{r}
censo_mrp <- censo_mrp <- readRDS("ingreso/datos/censo_mrp1.rds") %>%  
      mutate(
  region = recode(dam,
               "01" = "Central",
               "02" = "Chorotega",
               "03" = "Pacífico Central",
               "04" = "Brunca",
               "05" = "Huetar Caribe",
               "06" = "Huetar Norte")) %>%
  mutate(region = as.factor(region))


pred <- readRDS("ingreso/output/pred.rds")

censo_mrp$pred_ingreso <- pred
```

```{r}
ingreso_dam <- censo_mrp %>% 
  group_by(region) %>% 
  summarise(
    ingreso = mean(pred_ingreso)
  ) 
```


```{r}
mapping <- rbind(media_est_srvyr[,-3], ingreso_dam)

estim <- c(rep("Directo", 6), rep("XGBoost", 6))

mapping <- cbind(mapping, estim)
```

```{r}
plot_validacion <- mapping %>% 
  ggplot(
    aes(x = region,
        y = ingreso,
        col = estim)
  ) + geom_point(size = 2) + theme_minimal() +
    scale_color_manual(values = c("red","green")) +  
  labs(x = "Región de planificación", y = "Ingreso medio", fill = "Modelo") + ylim(0, 400000)
```

```{r}
ggsave(plot_validacion, filename = "ingreso/output/validacion.png")
```

```{r}
censo_mrp %>%
  group_by(region) %>% 
  summarise(
  media_ingreso = mean(pred_ingreso)
)
```

```{r}
encuesta_mrp %>% 
  group_by(region) %>% 
  summarise(
    media_ingreso = mean(ingreso)
  )
```


```{r}
encuesta_mrp %>% 
  group_by(edad) %>% 
  filter(edad == 1) %>% 
  select(edad, region, ingreso) %>% 
  summarise(n = n())
```


```{r}
prueba = subset(encuesta_mrp, edad == 1)

table(prueba$ingreso)
```


```{r}
encuesta_mrp %>% 
  filter(ingreso == 0) %>% 
  group_by(region) %>% 
  summarise(n = n())

```





